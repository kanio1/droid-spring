package com.droid.bss.infrastructure.security;

import org.aspectj.lang.ProceedingJoinPoint;
import org.aspectj.lang.annotation.Around;
import org.aspectj.lang.annotation.Aspect;
import org.springframework.security.access.AccessDeniedException;
import org.springframework.stereotype.Component;
import org.springframework.web.bind.annotation.RequestParam;

import java.lang.reflect.Parameter;
import java.util.Optional;

/**
 * Security Interceptor
 * Enforces RBAC and security policies
 */
@Aspect
@Component
public class SecurityInterceptor {

    private final SecurityService securityService;

    public SecurityInterceptor(SecurityService securityService) {
        this.securityService = securityService;
    }

    /**
     * Enforce permission requirements
     */
    @Around("@annotation(requirePermission)")
    public Object checkPermission(ProceedingJoinPoint joinPoint, RequirePermission requirePermission) throws Throwable {
        if (!securityService.hasPermission(requirePermission.value())) {
            throw new AccessDeniedException("Insufficient permissions: " + requirePermission.value());
        }
        return joinPoint.proceed();
    }

    /**
     * Enforce any permission requirement
     */
    @Around("@annotation(requireAnyPermission)")
    public Object checkAnyPermission(ProceedingJoinPoint joinPoint, RequireAnyPermission requireAnyPermission) throws Throwable {
        if (!securityService.hasAnyPermission(requireAnyPermission.value())) {
            throw new AccessDeniedException("Insufficient permissions: requires any of " + String.join(", ", requireAnyPermission.value()));
        }
        return joinPoint.proceed();
    }

    /**
     * Enforce all permissions requirement
     */
    @Around("@annotation(requireAllPermissions)")
    public Object checkAllPermissions(ProceedingJoinPoint joinPoint, RequireAllPermissions requireAllPermissions) throws Throwable {
        if (!securityService.hasAllPermissions(requireAllPermissions.value())) {
            throw new AccessDeniedException("Insufficient permissions: requires all of " + String.join(", ", requireAllPermissions.value()));
        }
        return joinPoint.proceed();
    }

    /**
     * Enforce role requirements
     */
    @Around("@annotation(requireRole)")
    public Object checkRole(ProceedingJoinPoint joinPoint, RequireRole requireRole) throws Throwable {
        if (!securityService.hasRole(requireRole.value())) {
            throw new AccessDeniedException("Insufficient role: " + requireRole.value());
        }
        return joinPoint.proceed();
    }

    /**
     * Enforce any role requirement
     */
    @Around("@annotation(requireAnyRole)")
    public Object checkAnyRole(ProceedingJoinPoint joinPoint, RequireAnyRole requireAnyRole) throws Throwable {
        if (!securityService.hasAnyRole(requireAnyRole.value())) {
            throw new AccessDeniedException("Insufficient role: requires any of " + String.join(", ", requireAnyRole.value()));
        }
        return joinPoint.proceed();
    }

    /**
     * Enforce admin requirement
     */
    @Around("@annotation(requireAdmin)")
    public Object checkAdmin(ProceedingJoinPoint joinPoint, RequireAdmin requireAdmin) throws Throwable {
        if (!securityService.isAdmin()) {
            throw new AccessDeniedException("Admin access required");
        }
        return joinPoint.proceed();
    }

    /**
     * Enforce authentication requirement
     */
    @Around("@annotation(requireAuthenticated)")
    public Object checkAuthenticated(ProceedingJoinPoint joinPoint, RequireAuthenticated requireAuthenticated) throws Throwable {
        Optional<SecurityService.UserIdentity> user = securityService.getCurrentUser();
        if (user.isEmpty()) {
            throw new AccessDeniedException("Authentication required");
        }
        return joinPoint.proceed();
    }

    /**
     * Enforce resource ownership
     */
    @Around("@annotation(requireOwner)")
    public Object checkOwner(ProceedingJoinPoint joinPoint, RequireOwner requireOwner) throws Throwable {
        // Get the owner ID from method parameters
        Object[] args = joinPoint.getArgs();
        Parameter[] parameters = joinPoint.getSignature().getDeclaringType()
            .getMethod(joinPoint.getSignature().getName(), (Class<?>[]) joinPoint.getArgs().getClass())
            .getParameters();

        String ownerId = null;
        for (int i = 0; i < parameters.length; i++) {
            Parameter param = parameters[i];
            if (param.getName().equals(requireOwner.value()) || param.isAnnotationPresent(RequestParam.class)) {
                ownerId = args[i].toString();
                break;
            }
        }

        if (ownerId == null) {
            throw new IllegalArgumentException("Owner ID parameter not found: " + requireOwner.value());
        }

        if (!securityService.isOwner(ownerId, requireOwner.value())) {
            throw new AccessDeniedException("Access denied: must be resource owner");
        }

        return joinPoint.proceed();
    }
}
