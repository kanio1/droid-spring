spring:
  application:
    name: bss-backend
  datasource:
    url: jdbc:postgresql://${POSTGRES_HOST:localhost}:${POSTGRES_PORT:6432}/${POSTGRES_DB:bss}
    username: ${POSTGRES_USER:bss_app}
    password: ${POSTGRES_PASSWORD:placeholder_password}
    driver-class-name: org.postgresql.Driver
    hikari:
      # PgBouncer optimization settings
      maximum-pool-size: ${DB_POOL_SIZE:20}
      minimum-idle: ${DB_MIN_IDLE:5}
      idle-timeout: 300000
      connection-timeout: 20000
      max-lifetime: 1200000
      leak-detection-threshold: 60000
      pool-name: bss-hikari-pool
      # Transaction pooling mode
      data-source-properties:
        prepareThreshold: 1
        cachePrepStmts: true
        prepStmtCacheSize: 250
        prepStmtCacheSqlLimit: 2048
        useServerPrepStmts: true
  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: false
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        format_sql: true
        # PgBouncer transaction mode compatibility
        jdbc:
          batch_size: 20
          order_inserts: true
          order_updates: true
    defer-datasource-initialization: false
  flyway:
    locations: classpath:db/migration
    enabled: true
    baseline-on-migrate: true

  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:#{null}}
      timeout: 2000ms
      lettuce:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 0
          max-wait: -1ms

  cache:
    type: redis
    redis:
      time-to-live: 300000
      cache-null-values: false

  session:
    store-type: redis
    redis:
      namespace: bss:session
      flush-mode: on_save
      timeout: 1800s
    timeout: 1800s
    redis:
      repository:
        enabled: true

  threads:
    virtual:
      enabled: true
  
  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: ${SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI:http://localhost:8081/realms/bss}

  # Kafka configuration for CloudEvents
  kafka:
    bootstrap-servers: ${KAFKA_BOOTSTRAP_SERVERS:kafka-1:9092,kafka-2:9092,kafka-3:9092}
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer
      acks: all
      retries: 3
      batch-size: 16384
      linger-ms: 5
      buffer-memory: 33554432
      properties:
        enable.idempotence: true
        max.in.flight.requests.per.connection: 1
        compression.type: snappy
        request.timeout.ms: 30000
    consumer:
      group-id: ${KAFKA_CONSUMER_GROUP_ID:bss-backend}
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      auto-offset-reset: earliest
      enable-auto-commit: false
      properties:
        spring.json.trusted.packages: "com.droid.bss.domain.*"
        fetch.min.bytes: 1024
        fetch.max.wait.ms: 500
        max.partition.fetch.bytes: 1048576
    template:
      default-topic: ${KAFKA_DEFAULT_TOPIC:bss.events}
    listener:
      ack-mode: manual_immediate
      concurrency: 3

security:
  oauth2:
    audience: ${SPRING_SECURITY_OAUTH2_RESOURCESERVER_AUDIENCE:bss-backend}

management:
  endpoints:
    web:
      base-path: /actuator
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      probes:
        enabled: true
      show-details: always
      show-components: always
    prometheus:
      enabled: true
  metrics:
    export:
      prometheus:
        enabled: true
    distribution:
      percentiles-histogram:
        http.server.requests: true
      sla:
        http.server.requests: 5ms,10ms,20ms,50ms,100ms,200ms,500ms,1s,2s,5s
    tags:
      application: ${spring.application.name}
  tracing:
    sampling:
      probability: 1.0
  otlp:
    tracing:
      endpoint: ${OTEL_EXPORTER_OTLP_TRACES_ENDPOINT:http://localhost:4318/v1/traces}

server:
  forward-headers-strategy: native
  tomcat:
    remoteip:
      protocol-header: X-Forwarded-Proto
      remote-ip-header: X-Forwarded-For
      host-header: X-Forwarded-Host
      port-header: X-Forwarded-Port
      internal-proxies: 127\.0\.0\.1|::1|10\.(\d{1,3}\.){2}\d{1,3}|172\.(1[6-9]|2[0-9]|3[0-1])\.(\d{1,3}\.)\d{1,3}|192\.168\.(\d{1,3}\.)\d{1,3}

springdoc:
  api-docs:
    path: /v3/api-docs
  swagger-ui:
    path: /swagger-ui.html
    operations-sorter: method
    tags-sorter: alpha
    filter: true
    display-request-duration: true
    show-extensions: true
    show-common-extensions: true
  packages-to-scan: com.droid.bss.api
  default-produces-media-type: application/json
  default-consumes-media-type: application/json
