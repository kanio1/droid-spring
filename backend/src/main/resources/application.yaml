spring:
  application:
    name: bss-backend
  datasource:
    url: jdbc:postgresql://${POSTGRES_HOST:localhost}:${POSTGRES_PORT:6432}/${POSTGRES_DB:bss}?sslmode=${DB_SSL_MODE:require}&ssl=true
    username: ${POSTGRES_USER:bss_app}
    password: ${POSTGRES_PASSWORD:placeholder_password}
    driver-class-name: org.postgresql.Driver
    hikari:
      # PgBouncer optimization settings
      maximum-pool-size: ${DB_POOL_SIZE:20}
      minimum-idle: ${DB_MIN_IDLE:5}
      idle-timeout: 300000
      connection-timeout: 20000
      max-lifetime: 1200000
      leak-detection-threshold: 60000
      pool-name: bss-hikari-pool
      # Transaction pooling mode
      data-source-properties:
        prepareThreshold: 1
        # SSL/TLS Configuration
        ssl: ${DB_SSL_ENABLED:true}
        sslmode: ${DB_SSL_MODE:require}
        sslrootcert: ${DB_SSL_ROOTCERT:/etc/ssl/certs/ca-cert.pem}
        sslcert: ${DB_SSL_CERT:}
        sslkey: ${DB_SSL_KEY:}
        sslcrl: ${DB_SSL_CRL:}
        sslcompression: ${DB_SSL_COMPRESSION:0}
        sslpassword: ${DB_SSL_PASSWORD:}
        sslcallback: ${DB_SSL_CALLBACK:}
        sslpasswordcallback: ${DB_SSL_PASSWORD_CALLBACK:}
        cachePrepStmts: true
        prepStmtCacheSize: 250
        prepStmtCacheSqlLimit: 2048
        useServerPrepStmts: true
  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: false
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        format_sql: true
        # PgBouncer transaction mode compatibility
        jdbc:
          batch_size: 20
          order_inserts: true
          order_updates: true
    defer-datasource-initialization: false
  flyway:
    locations: classpath:db/migration
    enabled: true
    baseline-on-migrate: true

  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:#{null}}
      timeout: 2000ms
      ssl:
        enabled: ${REDIS_SSL_ENABLED:true}
        keystore:
          location: ${REDIS_SSL_KEYSTORE:#{null}}
          password: ${REDIS_SSL_KEYSTORE_PASSWORD:#{null}}
        truststore:
          location: ${REDIS_SSL_TRUSTSTORE:/etc/ssl/certs/truststore.jks}
          password: ${REDIS_SSL_TRUSTSTORE_PASSWORD:changeit}
      lettuce:
        pool:
          max-active: 50
          max-idle: 20
          min-idle: 10
          max-wait: 2000ms

  cache:
    type: redis
    redis:
      time-to-live: 300000
      cache-null-values: false

# Cache Invalidation Configuration
bss:
  cache:
    invalidation:
      enabled: true
      warming:
        enabled: true
        interval-minutes: 10
        hot-key-threshold: 20
      probabilistic-expiration:
        enabled: true
        base-probability: 0.1
        check-interval-seconds: 30
        max-entries-to-check: 1000
        hot-key-reduction-factor: 0.5
      postgres-notify:
        enabled: true
        channel-name: cache_invalidation
      redis-listener:
        enabled: true
        topics:
          - cache:invalidation:key
          - cache:invalidation:pattern
          - cache:invalidation:prefix

  session:
    store-type: redis
    redis:
      namespace: bss:session
      flush-mode: on_save
      timeout: 1800s
      repository:
        enabled: true

  threads:
    virtual:
      enabled: true
  
  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: ${SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI:http://localhost:8081/realms/bss}

  # Email configuration for notifications
  mail:
    host: ${SMTP_HOST:smtp.gmail.com}
    port: ${SMTP_PORT:587}
    username: ${SMTP_USERNAME:}
    password: ${SMTP_PASSWORD:}
    properties:
      mail:
        smtp:
          auth: true
          starttls:
            enable: true

  # Kafka configuration for CloudEvents
  kafka:
    bootstrap-servers: ${KAFKA_BOOTSTRAP_SERVERS:kafka-1:9092,kafka-2:9092,kafka-3:9092}
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer
      acks: all
      retries: 3
      batch-size: 16384
      linger-ms: 5
      buffer-memory: 33554432
      properties:
        enable.idempotence: true
        max.in.flight.requests.per.connection: 1
        compression.type: snappy
        request.timeout.ms: 30000
        # SSL Configuration
        security.protocol: ${KAFKA_SSL_ENABLED:false}
        ssl.truststore.location: ${KAFKA_SSL_TRUSTSTORE_LOCATION:/etc/ssl/certs/truststore.jks}
        ssl.truststore.password: ${KAFKA_SSL_TRUSTSTORE_PASSWORD:changeit}
        ssl.keystore.location: ${KAFKA_SSL_KEYSTORE_LOCATION:/etc/ssl/certs/kafka/kafka.p12}
        ssl.keystore.password: ${KAFKA_SSL_KEYSTORE_PASSWORD:changeit}
        ssl.keystore.type: PKCS12
        ssl.client.auth: required
        ssl.enabled.protocols: TLSv1.2,TLSv1.3
        ssl.cipher.suites: TLS_AES_256_GCM_SHA384,TLS_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
    consumer:
      group-id: ${KAFKA_CONSUMER_GROUP_ID:bss-backend}
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      auto-offset-reset: earliest
      enable-auto-commit: false
      properties:
        spring.json.trusted.packages: "com.droid.bss.domain.*"
        fetch.min.bytes: 1024
        fetch.max.wait.ms: 500
        max.partition.fetch.bytes: 1048576
        # SSL Configuration
        security.protocol: ${KAFKA_SSL_ENABLED:false}
        ssl.truststore.location: ${KAFKA_SSL_TRUSTSTORE_LOCATION:/etc/ssl/certs/truststore.jks}
        ssl.truststore.password: ${KAFKA_SSL_TRUSTSTORE_PASSWORD:changeit}
        ssl.keystore.location: ${KAFKA_SSL_KEYSTORE_LOCATION:/etc/ssl/certs/kafka/kafka.p12}
        ssl.keystore.password: ${KAFKA_SSL_KEYSTORE_PASSWORD:changeit}
        ssl.keystore.type: PKCS12
        ssl.client.auth: required
        ssl.enabled.protocols: TLSv1.2,TLSv1.3
        ssl.cipher.suites: TLS_AES_256_GCM_SHA384,TLS_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
    template:
      default-topic: ${KAFKA_DEFAULT_TOPIC:bss.events}
    listener:
      ack-mode: manual_immediate
      concurrency: 3

security:
  oauth2:
    audience: ${SPRING_SECURITY_OAUTH2_RESOURCESERVER_AUDIENCE:bss-backend}

management:
  endpoints:
    web:
      base-path: /actuator
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      probes:
        enabled: true
      show-details: always
      show-components: always
    prometheus:
      enabled: true
  metrics:
    export:
      prometheus:
        enabled: true
    distribution:
      percentiles-histogram:
        http.server.requests: true
      sla:
        http.server.requests: 5ms,10ms,20ms,50ms,100ms,200ms,500ms,1s,2s,5s
    tags:
      application: ${spring.application.name}
  tracing:
    sampling:
      probability: 1.0
  otlp:
    tracing:
      endpoint: ${OTEL_EXPORTER_OTLP_TRACES_ENDPOINT:http://localhost:4318/v1/traces}

server:
  forward-headers-strategy: native
  tomcat:
    remoteip:
      protocol-header: X-Forwarded-Proto
      remote-ip-header: X-Forwarded-For
      host-header: X-Forwarded-Host

# Resilience4j Configuration
resilience4j:
  circuitbreaker:
    instances:
      backendService:
        failure-rate-threshold: 50
        wait-duration-in-open-state: 30s
        sliding-window-size: 10
        minimum-number-of-calls: 5
        slow-call-rate-threshold: 100
        slow-call-duration-threshold: 2s
        automatic-transition-from-open-to-half-open-enabled: true
        events:
          enable-emit-after-state-transition: true
      customerQueryService:
        failure-rate-threshold: 50
        wait-duration-in-open-state: 30s
        sliding-window-size: 10
        minimum-number-of-calls: 5
        slow-call-rate-threshold: 100
        slow-call-duration-threshold: 2s
        automatic-transition-from-open-to-half-open-enabled: true
        events:
          enable-emit-after-state-transition: true
      orderQueryService:
        failure-rate-threshold: 50
        wait-duration-in-open-state: 30s
        sliding-window-size: 10
        minimum-number-of-calls: 5
        slow-call-rate-threshold: 100
        slow-call-duration-threshold: 2s
        automatic-transition-from-open-to-half-open-enabled: true
        events:
          enable-emit-after-state-transition: true
    metrics:
      legacy:
        enabled: true
  retry:
    instances:
      backendService:
        max-attempts: 3
        wait-duration: 1s
        retry-exceptions:
          - org.springframework.web.client.HttpServerErrorException
          - java.io.IOException
      customerQueryService:
        max-attempts: 3
        wait-duration: 1s
        retry-exceptions:
          - java.sql.SQLException
          - org.springframework.jdbc.CannotGetJdbcConnectionException
      orderQueryService:
        max-attempts: 3
        wait-duration: 1s
        retry-exceptions:
          - java.sql.SQLException
          - org.springframework.jdbc.CannotGetJdbcConnectionException
  timelimiter:
    instances:
      backendService:
        timeout-duration: 5s
      customerQueryService:
        timeout-duration: 3s
      orderQueryService:
        timeout-duration: 3s
  ratelimiter:
    instances:
      backendService:
        limit-for-period: 50
        limit-refresh-period: 10s
        timeout-duration: 0s
        allow-health-indicator-to-exceed-limits: true
      customerQueryService:
        limit-for-period: 100
        limit-refresh-period: 10s
        timeout-duration: 0s
        allow-health-indicator-to-exceed-limits: true
      orderQueryService:
        limit-for-period: 100
        limit-refresh-period: 10s
        timeout-duration: 0s
        allow-health-indicator-to-exceed-limits: true

      port-header: X-Forwarded-Port
      internal-proxies: 127\.0\.0\.1|::1|10\.(\d{1,3}\.){2}\d{1,3}|172\.(1[6-9]|2[0-9]|3[0-1])\.(\d{1,3}\.)\d{1,3}|192\.168\.(\d{1,3}\.)\d{1,3}

springdoc:
  api-docs:
    path: /v3/api-docs
  swagger-ui:
    path: /swagger-ui.html
    operations-sorter: method
    tags-sorter: alpha
    filter: true
    display-request-duration: true
    show-extensions: true
    show-common-extensions: true
  packages-to-scan: com.droid.bss.api
  default-produces-media-type: application/json
  default-consumes-media-type: application/json
