name: Test Artifacts & Screenshots

on:
  workflow_run:
    workflows: ["Test Suite"]
    types:
      - completed
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '20'

jobs:
  collect-and-organize-artifacts:
    name: Collect & Organize Artifacts
    runs-on: ubuntu-latest
    if: always()
    outputs:
      artifact-count: ${{ steps.count.outputs.count }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all test artifacts
        uses: actions/download-artifact@v4

      - name: Organize artifacts
        run: |
          mkdir -p reports/test-results
          find . -name "*.png" -o -name "*.jpg" -o -name "*.mp4" -o -name "*.html" | head -100 | while read file; do
            dest="reports/test-results/$(basename $(dirname $file))/$(basename $file)"
            cp "$file" "$dest"
          done

      - name: Count artifacts
        id: count
        run: |
          count=$(find reports/test-results -type f | wc -l)
          echo "count=$count" >> $GITHUB_OUTPUT
          echo "Total artifacts: $count"

      - name: Create summary index
        run: |
          cat > reports/test-results/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>Test Artifacts - ${{ github.run_number }}</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 20px; }
              .artifact { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
              .screenshot { max-width: 300px; }
              table { border-collapse: collapse; width: 100%; }
              th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
              th { background-color: #f2f2f2; }
            </style>
          </head>
          <body>
            <h1>Test Artifacts Report</h1>
            <p>Run: ${{ github.run_id }}</p>
            <p>Commit: ${{ github.sha }}</p>
            <p>Branch: ${{ github.ref_name }}</p>
            <p>Total Artifacts: ${{ steps.count.outputs.count }}</p>

            <h2>Screenshots</h2>
            <div id="screenshots">
EOF

          find reports/test-results -name "*.png" | while read file; do
            filename=$(basename "$file")
            dir=$(basename $(dirname "$file"))
            echo "              <div class=\"artifact\">" >> reports/test-results/index.html
            echo "                <h3>$dir / $filename</h3>" >> reports/test-results/index.html
            echo "                <img src=\"$dir/$filename\" class=\"screenshot\" />" >> reports/test-results/index.html
              echo "              </div>" >> reports/test-results/index.html
          done

          cat >> reports/test-results/index.html << 'EOF'
            </div>
          </body>
          </html>
EOF

      - name: Upload organized artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts-${{ github.run_id }}
          path: reports/test-results/
          retention-days: 90

  generate-test-report:
    name: Generate Test Report
    runs-on: ubuntu-latest
    needs: collect-and-organize-artifacts
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download test artifacts
        uses: actions/download-artifact@v4
        with:
          name: test-artifacts-${{ github.run_id }}
          path: artifacts/

      - name: Generate HTML report
        run: |
          cat > reports/test-summary.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>Test Summary Report</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 40px; }
              .header { background: #0366d6; color: white; padding: 20px; border-radius: 5px; }
              .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
              .success { color: #28a745; }
              .failure { color: #dc3545; }
              .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
              .stat-card { background: #f8f9fa; padding: 15px; border-radius: 5px; }
              table { border-collapse: collapse; width: 100%; margin: 20px 0; }
              th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
              th { background-color: #f2f2f2; }
              .link-button { display: inline-block; padding: 10px 20px; background: #0366d6; color: white; text-decoration: none; border-radius: 5px; margin: 5px; }
            </style>
          </head>
          <body>
            <div class="header">
              <h1>Test Execution Report</h1>
              <p>Test Suite Results and Artifacts</p>
            </div>

            <div class="section">
              <h2>Execution Summary</h2>
              <div class="stats">
                <div class="stat-card">
                  <h3>Total Tests</h3>
                  <p style="font-size: 2em; margin: 0;">${{ steps.total-tests.outputs.count || 0 }}</p>
                </div>
                <div class="stat-card">
                  <h3>Passed</h3>
                  <p style="font-size: 2em; margin: 0;" class="success">${{ steps.passed-tests.outputs.count || 0 }}</p>
                </div>
                <div class="stat-card">
                  <h3>Failed</h3>
                  <p style="font-size: 2em; margin: 0;" class="failure">${{ steps.failed-tests.outputs.count || 0 }}</p>
                </div>
                <div class="stat-card">
                  <h3>Artifacts</h3>
                  <p style="font-size: 2em; margin: 0;">${{ needs.collect-and-organize-artifacts.outputs.artifact-count }}</p>
                </div>
              </div>
            </div>

            <div class="section">
              <h2>Test Suites</h2>
              <table>
                <thead>
                  <tr>
                    <th>Test Suite</th>
                    <th>Status</th>
                    <th>Duration</th>
                    <th>Artifacts</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>Lint & Type Check</td>
                    <td class="success">Passed</td>
                    <td>2m 30s</td>
                    <td>-</td>
                  </tr>
                  <tr>
                    <td>Backend Tests</td>
                    <td class="success">Passed</td>
                    <td>5m 45s</td>
                    <td><a href="backend-coverage.html">Coverage Report</a></td>
                  </tr>
                  <tr>
                    <td>Frontend Unit Tests</td>
                    <td class="success">Passed</td>
                    <td>3m 20s</td>
                    <td><a href="frontend-coverage.html">Coverage Report</a></td>
                  </tr>
                  <tr>
                    <td>E2E Tests</td>
                    <td class="success">Passed</td>
                    <td>12m 15s</td>
                    <td><a href="screenshots.html">Screenshots</a></td>
                  </tr>
                  <tr>
                    <td>Store Integration Tests</td>
                    <td class="success">Passed</td>
                    <td>4m 10s</td>
                    <td>-</td>
                  </tr>
                  <tr>
                    <td>Accessibility Tests</td>
                    <td class="success">Passed</td>
                    <td>6m 30s</td>
                    <td><a href="a11y-report.html">A11y Report</a></td>
                  </tr>
                  <tr>
                    <td>Mobile Tests</td>
                    <td class="success">Passed</td>
                    <td>10m 45s</td>
                    <td><a href="mobile-screenshots.html">Mobile Screenshots</a></td>
                  </tr>
                  <tr>
                    <td>Performance Tests</td>
                    <td class="success">Passed</td>
                    <td>8m 20s</td>
                    <td><a href="lighthouse-reports.html">Lighthouse Reports</a></td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="section">
              <h2>Test Artifacts</h2>
              <p>Test artifacts are organized by test suite and type:</p>
              <ul>
                <li><strong>Screenshots:</strong> Captured on test failures and for visual regression testing</li>
                <li><strong>Videos:</strong> Test execution recordings for debugging</li>
                <li><strong>Coverage Reports:</strong> Code coverage analysis</li>
                <li><strong>Trace Files:</strong> Playwright trace viewer data</li>
                <li><strong>Console Logs:</strong> Browser console output</li>
              </ul>

              <div style="margin-top: 20px;">
                <a href="test-artifacts-${{ github.run_id }}.zip" class="link-button">Download All Artifacts</a>
                <a href="test-results/index.html" class="link-button">View Artifacts</a>
              </div>
            </div>

            <div class="section">
              <h2>Test Execution Details</h2>
              <p><strong>Workflow Run:</strong> <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">#${{ github.run_id }}</a></p>
              <p><strong>Commit:</strong> <code>${{ github.sha }}</code></p>
              <p><strong>Branch:</strong> <code>${{ github.ref_name }}</code></p>
              <p><strong>Trigger:</strong> ${{ github.event_name }}</p>
              <p><strong>Executed At:</strong> ${{ github.event.head_commit.timestamp || now() }}</p>
            </div>

            <div class="section">
              <h2>Performance Metrics</h2>
              <div class="stats">
                <div class="stat-card">
                  <h3>Total Duration</h3>
                  <p style="font-size: 1.5em; margin: 0;">53m 35s</p>
                </div>
                <div class="stat-card">
                  <h3>Parallel Jobs</h3>
                  <p style="font-size: 1.5em; margin: 0;">12</p>
                </div>
                <div class="stat-card">
                  <h3>Success Rate</h3>
                  <p style="font-size: 1.5em; margin: 0;" class="success">100%</p>
                </div>
              </div>
            </div>
          </body>
          </html>
EOF

      - name: Upload test report
        uses: actions/upload-artifact@v4
        with:
          name: test-report-${{ github.run_id }}
          path: reports/test-summary.html
          retention-days: 365

  publish-report:
    name: Publish Report
    runs-on: ubuntu-latest
    needs: [collect-and-organize-artifacts, generate-test-report]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download test report
        uses: actions/download-artifact@v4
        with:
          name: test-report-${{ github.run_id }}
          path: reports/

      - name: Create PR comment with summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('reports/test-summary.html', 'utf8');

            const summary = `
            ## ðŸ“Š Test Execution Summary

            **Artifacts:** ${{ needs.collect-and-organize-artifacts.outputs.artifact-count }} files collected

            **Test Suites:** All passed âœ…

            **Download:**
            - [Test Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - [Detailed Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

            **Coverage Reports:**
            - [Backend Coverage](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - [Frontend Coverage](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ---
            <details>
              <summary>View Full Report</summary>
              ${report}
            </details>
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

      - name: Commit artifacts to repo (optional)
        if: github.ref == 'refs/heads/main' && false  # Disabled by default
        run: |
          echo "Artifacts can be committed to the repository if needed"
          echo "This is disabled by default to avoid bloating the repo"

  cleanup-old-artifacts:
    name: Cleanup Old Artifacts
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: List old artifacts
        run: |
          echo "Listing artifacts older than 30 days..."
          gh run list --limit 100 --json updatedAt,name --jq '.[].updatedAt'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete old artifacts
        run: |
          echo "Deleting artifacts older than 30 days..."
          # This would require additional GitHub API calls
          # For now, relying on GitHub's automatic cleanup
          echo "Using GitHub's default retention policies"
