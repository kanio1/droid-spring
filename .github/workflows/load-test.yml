name: Load Testing

on:
  schedule:
    # Run load tests every Sunday at 02:00 UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      duration:
        description: 'Test duration (minutes)'
        required: true
        default: '5'
        type: string
      virtual_users:
        description: 'Number of virtual users'
        required: true
        default: '100'
        type: string
      load_profile:
        description: 'Load profile'
        required: true
        default: 'normal'
        type: choice
        options:
          - light
          - normal
          - heavy
          - stress

jobs:
  # Load Test on Staging
  load-test-staging:
    runs-on: ubuntu-latest
    environment: staging
    if: github.ref == 'refs/heads/develop' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build backend
        run: mvn clean package -DskipTests
        working-directory: backend

      - name: Start application with loadtest profile
        run: |
          cd backend
          mvn spring-boot:run \
            -Dspring-boot.run.profiles=loadtest,staging \
            -Dspring-boot.run.arguments="--loadtest.durationMinutes=${{ github.event.inputs.duration || '5' }} --loadtest.virtualUsers=${{ github.event.inputs.virtual_users || '100' }}" &
          sleep 30

      - name: Wait for application to be ready
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:8080/actuator/health > /dev/null; then
              echo "Application is ready"
              exit 0
            fi
            echo "Waiting for application... ($i/30)"
            sleep 10
          done
          echo "Application failed to start"
          exit 1

      - name: Run load test
        run: |
          echo "Running load test with parameters:"
          echo "Duration: ${{ github.event.inputs.duration || '5' }} minutes"
          echo "Virtual Users: ${{ github.event.inputs.virtual_users || '100' }}"
          echo "Load Profile: ${{ github.event.inputs.load_profile || 'normal' }}"

          # Monitor application during load test
          timeout $(( (${{ github.event.inputs.duration || 5 }} + 1) * 60 )) bash -c '
            while true; do
              echo "[$(date)] Health check..."
              curl -s http://localhost:8080/actuator/health | jq .
              sleep 30
            done
          ' &
          MONITOR_PID=$!

          # Run actual load test
          cd backend
          mvn spring-boot:run \
            -Dspring-boot.run.profiles=loadtest \
            -Dspring-boot.run.arguments="--loadtest.durationMinutes=${{ github.event.inputs.duration || '5' }} --loadtest.virtualUsers=${{ github.event.inputs.virtual_users || '100' }}"

          # Kill monitor
          kill $MONITOR_PID 2>/dev/null || true

      - name: Collect metrics
        run: |
          echo "=== Application Metrics ==="
          curl -s http://localhost:8080/actuator/metrics | jq .
          echo ""
          echo "=== JVM Metrics ==="
          curl -s http://localhost:8080/actuator/metrics/jvm.memory.used | jq .
          curl -s http://localhost:8080/actuator/metrics/process.files.open | jq .
          echo ""
          echo "=== Database Metrics ==="
          curl -s http://localhost:8080/actuator/metrics/hikaricp.connections.active | jq .
          curl -s http://localhost:8080/actuator/metrics/hikaricp.connections.idle | jq .

      - name: Upload load test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: load-test-results
          path: |
            backend/target/*.log
            load-test-report.json

      - name: Comment PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const results = fs.readFileSync('load-test-report.json', 'utf8');
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## Load Test Results\n\n\`\`\`json\n${results}\n\`\`\``
              });
            } catch (error) {
              console.log('Could not read load test results');
            }

  # Performance Benchmark
  performance-benchmark:
    runs-on: ubuntu-latest
    needs: load-test-staging
    if: always() && (needs.load-test-staging.result == 'success' || needs.load-test-staging.result == 'failure')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download load test results
        uses: actions/download-artifact@v4
        with:
          name: load-test-results
          path: load-test-results/

      - name: Generate performance report
        run: |
          echo "=== Performance Benchmark Report ===" > performance-report.md
          echo "" >> performance-report.md
          echo "| Metric | Value |" >> performance-report.md
          echo "|--------|-------|" >> performance-report.md
          echo "| Test Date | $(date) |" >> performance-report.md
          echo "| Branch | ${{ github.ref_name }} |" >> performance-report.md
          echo "| Commit | ${{ github.sha }} |" >> performance-report.md
          echo "" >> performance-report.md

          if [ -f "load-test-results/load-test-report.json" ]; then
            echo "### Load Test Results" >> performance-report.md
            cat load-test-results/load-test-report.json >> performance-report.md
          fi

      - name: Upload performance report
        uses: actions/upload-artifact@v4
        with:
          name: performance-report
          path: performance-report.md

      - name: Post comment to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('performance-report.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });
