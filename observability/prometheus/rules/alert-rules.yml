# Alerting Rules for BSS System
# Defines critical alerts for application, infrastructure, and business metrics

groups:
  - name: bss-backend-alerts
    rules:
      # High-level application alerts

      # Application Down
      - alert: BackendDown
        expr: up{job="bss-backend"} == 0
        for: 1m
        labels:
          severity: critical
          team: backend
          service: bss-backend
        annotations:
          summary: "BSS Backend is down"
          description: "BSS Backend has been down for more than 1 minute"
          runbook_url: "https://wiki.company.com/runbooks/backend-down"
          dashboard_url: "https://grafana.company.com/d/bss-backend"

      # High Error Rate
      - alert: HighErrorRate
        expr: |
          (
            rate(http_server_requests_total{job="bss-backend",status=~"5.."}[5m])
            /
            rate(http_server_requests_total{job="bss-backend"}[5m])
          ) > 0.05
        for: 2m
        labels:
          severity: critical
          team: backend
          service: bss-backend
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value | humanizePercentage }} for the last 5 minutes"
          runbook_url: "https://wiki.company.com/runbooks/high-error-rate"

      # High Response Time
      - alert: HighResponseTime
        expr: |
          histogram_quantile(0.95,
            rate(http_server_requests_duration_seconds_bucket{job="bss-backend"}[5m])
          ) > 0.5
        for: 5m
        labels:
          severity: warning
          team: backend
          service: bss-backend
        annotations:
          summary: "High response time detected"
          description: "95th percentile response time is {{ $value }}s"
          runbook_url: "https://wiki.company.com/runbooks/high-response-time"

      # High Response Time (Critical)
      - alert: HighResponseTimeCritical
        expr: |
          histogram_quantile(0.95,
            rate(http_server_requests_duration_seconds_bucket{job="bss-backend"}[5m])
          ) > 1
        for: 2m
        labels:
          severity: critical
          team: backend
          service: bss-backend
        annotations:
          summary: "Critical response time detected"
          description: "95th percentile response time is {{ $value }}s"

      # JVM Memory Usage High
      - alert: JVMMemoryUsageHigh
        expr: |
          (jvm_memory_used_bytes{job="bss-backend"}
          /
          jvm_memory_max_bytes{job="bss-backend"}) > 0.9
        for: 5m
        labels:
          severity: warning
          team: backend
          service: bss-backend
        annotations:
          summary: "JVM memory usage is high"
          description: "JVM memory usage is {{ $value | humanizePercentage }}"
          runbook_url: "https://wiki.company.com/runbooks/jvm-memory"

      # JVM Memory Usage Critical
      - alert: JVMMemoryUsageCritical
        expr: |
          (jvm_memory_used_bytes{job="bss-backend"}
          /
          jvm_memory_max_bytes{job="bss-backend"}) > 0.95
        for: 2m
        labels:
          severity: critical
          team: backend
          service: bss-backend
        annotations:
          summary: "JVM memory usage is critical"
          description: "JVM memory usage is {{ $value | humanizePercentage }}"

      # Database Connection Pool Exhausted
      - alert: DatabaseConnectionPoolExhausted
        expr: |
          HikariPool_Connections_Active{job="bss-backend"}
          >=
          HikariPool_Connections_Max{job="bss-backend"}
        for: 2m
        labels:
          severity: critical
          team: backend
          service: bss-backend
        annotations:
          summary: "Database connection pool exhausted"
          description: "All {{ $value }} database connections are in use"
          runbook_url: "https://wiki.company.com/runbooks/db-connection-pool"

      # CPU Usage High
      - alert: CPUUsageHigh
        expr: system_cpu_usage{job="bss-backend"} > 0.8
        for: 5m
        labels:
          severity: warning
          team: backend
          service: bss-backend
        annotations:
          summary: "High CPU usage detected"
          description: "CPU usage is {{ $value | humanizePercentage }}"

      # CPU Usage Critical
      - alert: CPUUsageCritical
        expr: system_cpu_usage{job="bss-backend"} > 0.9
        for: 2m
        labels:
          severity: critical
          team: backend
          service: bss-backend
        annotations:
          summary: "Critical CPU usage detected"
          description: "CPU usage is {{ $value | humanizePercentage }}"

  - name: bss-business-alerts
    rules:
      # Business metric alerts

      # Low Customer Creation Rate
      - alert: LowCustomerCreationRate
        expr: |
          rate(bss_customers_created_total[1h]) < 0.1
        for: 10m
        labels:
          severity: warning
          team: backend
          service: bss-backend
        annotations:
          summary: "Low customer creation rate"
          description: "Customer creation rate is {{ $value }} customers/minute"
          runbook_url: "https://wiki.company.com/runbooks/low-customer-creation"

      # Failed Invoices
      - alert: HighInvoiceFailureRate
        expr: |
          (
            rate(bss_invoices_failed_total[5m])
            /
            rate(bss_invoices_total[5m])
          ) > 0.1
        for: 5m
        labels:
          severity: critical
          team: billing
          service: billing
        annotations:
          summary: "High invoice failure rate"
          description: "Invoice failure rate is {{ $value | humanizePercentage }}"

      # Payment Processing Failures
      - alert: HighPaymentFailureRate
        expr: |
          (
            rate(bss_payments_failed_total[5m])
            /
            rate(bss_payments_total[5m])
          ) > 0.05
        for: 5m
        labels:
          severity: critical
          team: billing
          service: payments
        annotations:
          summary: "High payment failure rate"
          description: "Payment failure rate is {{ $value | humanizePercentage }}"

  - name: infrastructure-alerts
    rules:
      # Infrastructure alerts

      # PostgreSQL Down
      - alert: PostgreSQLDown
        expr: up{job="postgresql"} == 0
        for: 1m
        labels:
          severity: critical
          team: infrastructure
          service: postgresql
        annotations:
          summary: "PostgreSQL database is down"
          description: "PostgreSQL database has been down for more than 1 minute"
          runbook_url: "https://wiki.company.com/runbooks/postgresql-down"

      # PostgreSQL High Connections
      - alert: PostgreSQLHighConnections
        expr: |
          pg_stat_database_numbackends / pg_settings_max_connections > 0.8
        for: 5m
        labels:
          severity: warning
          team: infrastructure
          service: postgresql
        annotations:
          summary: "PostgreSQL has high connection count"
          description: "PostgreSQL is using {{ $value | humanizePercentage }} of max connections"

      # Redis Down
      - alert: RedisDown
        expr: up{job="redis"} == 0
        for: 1m
        labels:
          severity: critical
          team: infrastructure
          service: redis
        annotations:
          summary: "Redis is down"
          description: "Redis has been down for more than 1 minute"

      # Kafka Down
      - alert: KafkaDown
        expr: up{job="kafka"} == 0
        for: 1m
        labels:
          severity: critical
          team: infrastructure
          service: kafka
        annotations:
          summary: "Kafka is down"
          description: "Kafka has been down for more than 1 minute"

      # Keycloak Down
      - alert: KeycloakDown
        expr: up{job="keycloak"} == 0
        for: 1m
        labels:
          severity: critical
          team: infrastructure
          service: keycloak
        annotations:
          summary: "Keycloak is down"
          description: "Keycloak has been down for more than 1 minute"

      # Disk Space Low
      - alert: DiskSpaceLow
        expr: |
          (node_filesystem_avail_bytes * 100 / node_filesystem_size_bytes) < 10
        for: 5m
        labels:
          severity: critical
          team: infrastructure
        annotations:
          summary: "Disk space is low"
          description: "Disk space is {{ $value | humanizePercentage }} free on {{ $labels.mountpoint }}"

      # Node Memory Low
      - alert: NodeMemoryLow
        expr: |
          (node_memory_MemAvailable_bytes * 100 / node_memory_MemTotal_bytes) < 10
        for: 5m
        labels:
          severity: warning
          team: infrastructure
        annotations:
          summary: "Node memory is low"
          description: "Node memory is {{ $value | humanizePercentage }} free"

  - name: saturation-alerts
    rules:
      # Saturation alerts

      # High Load Average
      - alert: HighLoadAverage
        expr: |
          (node_load1 / count(node_cpu_seconds_total{mode="idle"}) by (instance)) > 0.8
        for: 5m
        labels:
          severity: warning
          team: infrastructure
        annotations:
          summary: "High load average"
          description: "Load average is {{ $value | humanizePercentage }} on {{ $labels.instance }}"

      # Container Restart
      - alert: ContainerRestart
        expr: |
          increase(kube_pod_container_status_restarts_total[1h]) > 3
        for: 0m
        labels:
          severity: warning
          team: infrastructure
        annotations:
          summary: "Container is restarting frequently"
          description: "Container {{ $labels.container }} in pod {{ $labels.pod }} has restarted {{ $value }} times in the last hour"

  - name: slo-alerts
    rules:
      # SLO-based alerts

      # API Availability SLO Breach
      - alert: APIAvailabilitySLOBreach
        expr: |
          (
            sum(rate(http_server_requests_total{job="bss-backend",status!~"5.."}[5m]))
            /
            sum(rate(http_server_requests_total{job="bss-backend"}[5m]))
          ) < 0.995
        for: 2m
        labels:
          severity: critical
          team: backend
          service: bss-backend
          slo: "availability"
          target: "99.5%"
        annotations:
          summary: "API availability SLO breach"
          description: "API availability is {{ $value | humanizePercentage }} (SLO target: 99.5%)"
          runbook_url: "https://wiki.company.com/runbooks/slo-breach"

      # API Latency SLO Breach
      - alert: APILatencySLOBreach
        expr: |
          histogram_quantile(0.99,
            rate(http_server_requests_duration_seconds_bucket{job="bss-backend"}[5m])
          ) > 1
        for: 5m
        labels:
          severity: warning
          team: backend
          service: bss-backend
          slo: "latency"
          target: "1s"
        annotations:
          summary: "API latency SLO breach"
          description: "99th percentile latency is {{ $value }}s (SLO target: 1s)"
