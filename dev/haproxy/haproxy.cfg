# HAProxy Configuration for PostgreSQL Read Replica Load Balancing
# BSS System - Phase 3

global
  log stdout local0
  maxconn 4096
  user haproxy
  group haproxy
  daemon

defaults
  log     global
  mode    tcp
  option  tcplog
  option  dontlognull
  timeout connect 5000
  timeout client  50000
  timeout server  50000
  retries 3

# Frontend for PostgreSQL (read queries)
frontend postgres_frontend
  bind *:5432
  default_backend postgres_servers
  mode tcp

# Backend - PostgreSQL servers
backend postgres_servers
  balance roundrobin
  mode tcp
  option httpchk GET /

  # Primary server (write operations - read-only connections rejected)
  server postgres_primary bss-postgres:5432 check inter 5s rise 2 fall 3

  # Read Replica 1
  server postgres_replica_1 bss-postgres-replica-1:5432 check inter 5s rise 2 fall 3

  # Read Replica 2
  server postgres_replica_2 bss-postgres-replica-2:5432 check inter 5s rise 2 fall 3

# Statistics page
frontend stats
  bind *:8084
  stats enable
  stats uri /stats
  stats refresh 30s
  stats show-node
  stats show-legends
  stats admin if TRUE

# Frontend for monitoring HAProxy
listen monitoring
  bind *:8085
  mode http
  stats enable
  stats uri /haproxy
  stats refresh 30s
  stats show-node
  stats show-legends
