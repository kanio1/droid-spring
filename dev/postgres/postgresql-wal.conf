# PostgreSQL WAL (Write-Ahead Log) Archiving Configuration
# Enables Point-in-Time Recovery (PITR) and automated backups

# ============================================================================
# WAL ARCHIVING CONFIGURATION
# ============================================================================

# Enable WAL archiving
wal_level = replica

# Archive mode (requires superuser privileges)
archive_mode = on

# Archive command - sends WAL files to backup storage
# Example: AWS S3
archive_command = 'aws s3 cp %p s3://bss-postgres-backups/wal/%f'

# Alternative: Local filesystem backup
# archive_command = 'cp %p /var/lib/postgresql/wal_archive/%f'

# Archive timeout (send WAL every 60 seconds)
archive_timeout = 60

# Keep enough WAL files for PITR (7 days worth)
max_wal_senders = 10
max_replication_slots = 10

# Minimum and maximum WAL size
min_wal_size = 2GB
max_wal_size = 4GB

# ============================================================================
# BACKUP CONFIGURATION
# ============================================================================

# Use pg_basebackup for full backups
# Run daily: pg_basebackup -h localhost -U replication -D /backup/base -Ft -z -P

# Alternative: Use pgBackRest for advanced backup features
# Install: https://pgbackrest.org/
# Configuration:
#   [global]
#   repo1-type=s3
#   repo1-s3-bucket=bss-postgres-backups
#   repo1-retention-full=7
#   [main]
#   pg1-path=/var/lib/postgresql/data
#   pg1-host=localhost
#   pg1-host-user=postgres

# ============================================================================
# RECOVERY CONFIGURATION
# ============================================================================

# To restore to a specific point in time, create recovery.signal file
# and set recovery.target_time in postgresql.conf:
# recovery.signal
# recovery_target_time = '2025-11-07 14:30:00'
# recovery_target_action = promote

# ============================================================================
# MONITORING CONFIGURATION
# ============================================================================

# Track archive status
track_activities = on
track_counts = on
track_io_timing = on
track_wal_io_timing = on

# Log archiving
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_min_messages = info
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h] '

# ============================================================================
# RECOMMENDED BACKUP SCHEDULE
# ============================================================================

# Full backup (pg_basebackup): Daily at 2 AM
# 0 2 * * * pg_basebackup -h localhost -U postgres -D /backup/base/$(date +\%Y\%m\%d) -Ft -z -P -W

# WAL archive cleanup: Keep last 30 days
# 0 3 * * * find /var/lib/postgresql/wal_archive -name "*.gz" -mtime +30 -delete

# Verification: Check backup integrity weekly
# 0 4 * * 0 pg_basebackup --verify-path /backup/base/$(date +\%Y\%m\%d -d "yesterday")
