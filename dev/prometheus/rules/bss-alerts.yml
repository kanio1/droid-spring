# BSS Custom Alert Rules
# Alerts for 400k events/min infrastructure monitoring

groups:
  - name: bss-system-alerts
    rules:
      # ============================================================================
      # SYSTEM HEALTH ALERTS
      # ============================================================================

      # Service Down Alert
      - alert: ServiceDown
        expr: up == 0
        for: 0m
        labels:
          severity: critical
          team: sre
        annotations:
          summary: "Service {{ $labels.job }} is down"
          description: "{{ $labels.job }} on {{ $labels.instance }} has been down for more than 0 minutes."

      # High CPU Usage
      - alert: HighCPUUsage
        expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
          team: sre
        annotations:
          summary: "High CPU usage detected"
          description: "CPU usage is above 80% on {{ $labels.instance }} for more than 5 minutes."

      # High Memory Usage
      - alert: HighMemoryUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
        for: 5m
        labels:
          severity: warning
          team: sre
        annotations:
          summary: "High memory usage detected"
          description: "Memory usage is above 85% on {{ $labels.instance }} for more than 5 minutes."

      # Disk Space Low
      - alert: DiskSpaceLow
        expr: (1 - (node_filesystem_avail_bytes / node_filesystem_size_bytes)) * 100 > 85
        for: 5m
        labels:
          severity: critical
          team: sre
        annotations:
          summary: "Disk space is low"
          description: "Disk usage is above 85% on {{ $labels.instance }} mount {{ $labels.mountpoint }}."

  - name: postgresql-alerts
    rules:
      # ============================================================================
      # POSTGRESQL ALERTS
      # ============================================================================

      # PostgreSQL Down
      - alert: PostgreSQLDown
        expr: pg_up == 0
        for: 0m
        labels:
          severity: critical
          team: database
        annotations:
          summary: "PostgreSQL is down"
          description: "PostgreSQL instance {{ $labels.instance }} is down."

      # High Connection Usage
      - alert: PostgreSQLTooManyConnections
        expr: pg_stat_database_numbackends / pg_settings_max_connections * 100 > 80
        for: 5m
        labels:
          severity: warning
          team: database
        annotations:
          summary: "PostgreSQL high connection usage"
          description: "PostgreSQL has {{ $value }}% of max connections in use on {{ $labels.instance }}."

      # Slow Queries
      - alert: PostgreSQLSlowQueries
        expr: pg_stat_activity_max_tx_duration > 300
        for: 1m
        labels:
          severity: warning
          team: database
        annotations:
          summary: "PostgreSQL slow query detected"
          description: "Query running for {{ $value }} seconds on {{ $labels.instance }}."

      # Low Cache Hit Rate
      - alert: PostgreSQLLowCacheHitRate
        expr: (1 - (pg_stat_database_blks_hit / (pg_stat_database_blks_hit + pg_stat_database_blks_read))) * 100 > 90
        for: 5m
        labels:
          severity: warning
          team: database
        annotations:
          summary: "PostgreSQL low cache hit rate"
          description: "Cache hit rate is {{ $value }}% on {{ $labels.instance }}."

      # Replication Lag
      - alert: PostgreSQLReplicationLag
        expr: pg_replication_lag > 10
        for: 1m
        labels:
          severity: warning
          team: database
        annotations:
          summary: "PostgreSQL replication lag"
          description: "Replication lag is {{ $value }} seconds on {{ $labels.instance }}."

  - name: redis-alerts
    rules:
      # ============================================================================
      # REDIS ALERTS
      # ============================================================================

      # Redis Down
      - alert: RedisDown
        expr: redis_up == 0
        for: 0m
        labels:
          severity: critical
          team: cache
        annotations:
          summary: "Redis is down"
          description: "Redis instance {{ $labels.instance }} is down."

      # High Memory Usage
      - alert: RedisHighMemoryUsage
        expr: redis_memory_used_bytes / redis_memory_max_bytes * 100 > 90
        for: 5m
        labels:
          severity: warning
          team: cache
        annotations:
          summary: "Redis high memory usage"
          description: "Redis memory usage is {{ $value }}% on {{ $labels.instance }}."

      # High Connection Count
      - alert: RedisHighConnections
        expr: redis_connected_clients > 1000
        for: 5m
        labels:
          severity: warning
          team: cache
        annotations:
          summary: "Redis high connection count"
          description: "Redis has {{ $value }} connected clients on {{ $labels.instance }}."

      # Low Hit Rate
      - alert: RedisLowHitRate
        expr: rate(redis_keyspace_hits_total[5m]) / (rate(redis_keyspace_hits_total[5m]) + rate(redis_keyspace_misses_total[5m])) < 0.8
        for: 5m
        labels:
          severity: warning
          team: cache
        annotations:
          summary: "Redis low hit rate"
          description: "Redis hit rate is {{ $value | humanizePercentage }} on {{ $labels.instance }}."

  - name: kafka-alerts
    rules:
      # ============================================================================
      # KAFKA ALERTS
      # ============================================================================

      # Kafka Broker Down
      - alert: KafkaBrokerDown
        expr: kafka_brokers < 3
        for: 0m
        labels:
          severity: critical
          team: streaming
        annotations:
          summary: "Kafka broker is down"
          description: "Kafka has only {{ $value }} brokers running (expected 3)."

      # High Consumer Lag
      - alert: KafkaHighConsumerLag
        expr: kafka_consumer_lag_sum > 10000
        for: 5m
        labels:
          severity: warning
          team: streaming
        annotations:
          summary: "Kafka high consumer lag"
          description: "Consumer group {{ $labels.consumergroup }} has {{ $value }} lag on topic {{ $labels.topic }}."

      # Under Replicated Partitions
      - alert: KafkaUnderReplicatedPartitions
        expr: kafka_under_replicated_partitions > 0
        for: 5m
        labels:
          severity: critical
          team: streaming
        annotations:
          summary: "Kafka under-replicated partitions"
          description: "Kafka has {{ $value }} under-replicated partitions."

      # Offline Partitions
      - alert: KafkaOfflinePartitions
        expr: kafka_offline_partitions > 0
        for: 0m
        labels:
          severity: critical
          team: streaming
        annotations:
          summary: "Kafka offline partitions"
          description: "Kafka has {{ $value }} offline partitions."

  - name: bss-business-alerts
    rules:
      # ============================================================================
      # BSS BUSINESS METRICS ALERTS
      # ============================================================================

      # Event Throughput Below Target
      - alert: BSSLowEventThroughput
        expr: rate(bss_events_total[1m]) < 100
        for: 5m
        labels:
          severity: critical
          team: sre
          business_metric: "true"
        annotations:
          summary: "BSS event throughput is low"
          description: "Event throughput is {{ $value }} events/sec (target: 111 events/sec = 400k/min)"

      # Payment Processing Failures
      - alert: BSSHighPaymentFailureRate
        expr: rate(bss_payment_failures_total[5m]) / rate(bss_payment_attempts_total[5m]) > 0.05
        for: 2m
        labels:
          severity: warning
          team: payments
          business_metric: "true"
        annotations:
          summary: "High payment failure rate"
          description: "Payment failure rate is {{ $value | humanizePercentage }} (threshold: 5%)"

      # Order Processing Slow
      - alert: BSSSlowOrderProcessing
        expr: histogram_quantile(0.95, rate(bss_order_processing_duration_seconds_bucket[5m])) > 5
        for: 5m
        labels:
          severity: warning
          team: orders
          business_metric: "true"
        annotations:
          summary: "Order processing is slow"
          description: "95th percentile order processing time is {{ $value }}s (threshold: 5s)"

      # High API Latency
      - alert: BSSHighAPILatency
        expr: histogram_quantile(0.99, rate(http_request_duration_seconds_bucket{job="bss-backend"}[5m])) > 1
        for: 5m
        labels:
          severity: warning
          team: api
          business_metric: "true"
        annotations:
          summary: "BSS API latency is high"
          description: "99th percentile API latency is {{ $value }}s (threshold: 1s)"

      # SLA Breach Warning
      - alert: BSSSLAWarning
        expr: rate(bss_events_total[5m]) < 95
        for: 1m
        labels:
          severity: critical
          team: sre
          sla: "true"
        annotations:
          summary: "BSS SLA warning"
          description: "Event processing rate is {{ $value }}% of target (SLA: 95% of 6,667 events/sec)"

  - name: bss-capacity-alerts
    rules:
      # ============================================================================
      # CAPACITY PLANNING ALERTS
      # ============================================================================

      # Approaching Capacity
      - alert: BSSApproachingCapacity
        expr: rate(bss_events_total[5m]) / 111 > 0.8
        for: 10m
        labels:
          severity: warning
          team: sre
          capacity: "true"
        annotations:
          summary: "BSS approaching capacity"
          description: "System is at {{ $value | humanizePercentage }} of capacity (400k events/min target)"

      # High Resource Utilization Trend
      - alert: BSSHighResourceTrend
        expr: predict_linear(node_load1[1h], 4*60) > 1.5
        for: 10m
        labels:
          severity: warning
          team: sre
          capacity: "true"
        annotations:
          summary: "High resource utilization trend"
          description: "Load is trending upward on {{ $labels.instance }}"

      # Database Growth Rate
      - alert: BSSHighDBGrowthRate
        expr: rate(pg_stat_database_blks_read[1h]) > 1000
        for: 30m
        labels:
          severity: info
          team: database
          capacity: "true"
        annotations:
          summary: "High database growth rate"
          description: "Database read rate is {{ $value }} blocks/sec on {{ $labels.instance }}"
