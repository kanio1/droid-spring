# Kong API Gateway Configuration
# This file configures routes and services for the BSS system

_format_version: "3.0"

# ==========================================
# SERVICES
# ==========================================

services:
  # Backend API Service
  - name: bss-backend-service
    url: http://backend:8080
    routes:
      - name: backend-route
        paths:
          - /api
        strip_path: false
    plugins:
      - name: cors
      - name: request-size-limiting
        config:
          allowed_payload_size: 10
      - name: correlation-id
        config:
          header_name: X-Correlation-ID
          echo_downstream: true
    retries: 3
    read_timeout: 60000
    write_timeout: 60000
    connect_timeout: 60000

  # Backend API - Authentication Endpoints (stricter limits)
  - name: bss-auth-service
    url: http://backend:8080
    routes:
      - name: auth-route
        paths:
          - /api/auth
        strip_path: false
    plugins:
      - name: cors
      - name: rate-limiting
        config:
          minute: 60
          hour: 500
          day: 5000
          policy: local
          redis_host: redis
          redis_port: 6379
          redis_database: 0
      - name: request-size-limiting
        config:
          allowed_payload_size: 5
    host_header: localhost:3001

  # Backend API - Customer Management (moderate limits)
  - name: bss-customer-service
    url: http://backend:8080
    routes:
      - name: customer-route
        paths:
          - /api/customers
        strip_path: false
    plugins:
      - name: cors
      - name: rate-limiting
        config:
          minute: 300
          hour: 5000
          day: 50000
          policy: local
      - name: request-size-limiting
        config:
          allowed_payload_size: 10

  # Backend API - Billing/Invoice (stricter - financial data)
  - name: bss-billing-service
    url: http://backend:8080
    routes:
      - name: billing-route
        paths:
          - /api/billing
          - /api/invoices
        strip_path: false
    plugins:
      - name: cors
      - name: rate-limiting
        config:
          minute: 200
          hour: 3000
          day: 30000
          policy: local
      - name: request-size-limiting
        config:
          allowed_payload_size: 10

  # Backend API - Public/Read endpoints (higher limits)
  - name: bss-public-service
    url: http://backend:8080
    routes:
      - name: public-route
        paths:
          - /api/public
        strip_path: false
    plugins:
      - name: cors
      - name: rate-limiting
        config:
          minute: 2000
          hour: 20000
          day: 200000
          policy: local
      - name: request-size-limiting
        config:
          allowed_payload_size: 10

  # Grafana Service
  - name: grafana-service
    url: http://grafana:3000
    routes:
      - name: grafana-route
        paths:
          - /grafana
        strip_path: true
    plugins:
      - name: cors
    host_header: localhost:3001

  # Prometheus Service
  - name: prometheus-service
    url: http://prometheus:9090
    routes:
      - name: prometheus-route
        paths:
          - /prometheus
        strip_path: true
    plugins:
      - name: cors

  # Jaeger Service
  - name: jaeger-service
    url: http://jaeger:16686
    routes:
      - name: jaeger-route
        paths:
          - /jaeger
        strip_path: true
    plugins:
      - name: cors

  # PgHero Service
  - name: pghero-service
    url: http://pghero:3000
    routes:
      - name: pghero-route
        paths:
          - /pghero
        strip_path: true
    plugins:
      - name: cors

  # AKHQ Service
  - name: akhq-service
    url: http://akhq:8080
    routes:
      - name: akhq-route
        paths:
          - /akhq
        strip_path: true
    plugins:
      - name: cors

# ==========================================
# CONSUMERS (API Keys)
# ==========================================

consumers:
  # Frontend Client (web app) - Balanced limits
  - username: bss-frontend
    keyauth_credentials:
      - key: frontend_api_key_123
    tags:
      - frontend
      - internal
    rate_limit_tier: standard

  # Mobile Client (mobile apps) - Similar to frontend
  - username: bss-mobile
    keyauth_credentials:
      - key: mobile_api_key_456
    tags:
      - mobile
      - external
    rate_limit_tier: standard

  # Partner/B2B Client - Higher limits for API integration
  - username: bss-partner
    keyauth_credentials:
      - key: partner_api_key_789
    tags:
      - partner
      - external
    rate_limit_tier: premium

  # Admin Client - Strict limits for administrative operations
  - username: bss-admin
    keyauth_credentials:
      - key: admin_api_key_999
    tags:
      - admin
      - internal
    rate_limit_tier: restricted

  # Anonymous/Unauthenticated - Very strict limits
  - username: anonymous
    keyauth_credentials:
      - key: anon_key_000
    tags:
      - anonymous
      - public
    rate_limit_tier: minimal

# ==========================================
# PLUGINS (Global)
# ==========================================

plugins:
  # Rate Limiting Tier: Standard (Frontend/Mobile)
  - name: rate-limiting
    route:
      _path_: /api/auth
    config:
      minute: 60
      hour: 500
      day: 5000
      policy: local
      limit_by: credential
      hide_client_headers: false
    consumer: bss-frontend,bss-mobile

  # Rate Limiting Tier: Premium (Partners) - Higher limits
  - name: rate-limiting
    service: bss-backend-service
    config:
      minute: 2000
      hour: 20000
      day: 200000
      policy: local
      limit_by: credential
      hide_client_headers: false
    consumer: bss-partner

  # Rate Limiting Tier: Restricted (Admin) - Lower limits
  - name: rate-limiting
    route:
      _path_: /api/admin
    config:
      minute: 30
      hour: 200
      day: 2000
      policy: local
      limit_by: credential
      hide_client_headers: false
    consumer: bss-admin

  # Rate Limiting Tier: Minimal (Anonymous) - Very strict
  - name: rate-limiting
    route:
      _path_: /api/public
    config:
      minute: 10
      hour: 50
      day: 500
      policy: local
      limit_by: ip
      hide_client_headers: false
    consumer: anonymous

  # Burst Protection - Limit request bursts
  - name: proxy-cache
    config:
      response_code:
        - 200
        - 201
        - 204
      request_method:
        - GET
        - HEAD
      content_type:
        - text/plain
        - application/json
      cache_ttl: 30
      strategy: memory

  # Enable Prometheus metrics
  - name: prometheus
    config:
      per_consumer: true
      status_code_metrics: true
      latency_metrics: true
      bandwidth_metrics: true
      upstream_health_metrics: true

  # Enable logging
  - name: http-log
    config:
      http_endpoint: http://loki:3100/loki/api/v1/push
      method: POST
      content_type: application/json
      json_payload:
        timestamp: "@timestamp"
        level: "info"
        gateway: "kong"
        route: "{{route.name}}"
        service: "{{service.name}}"
        method: "{{request.method}}"
        uri: "{{request.uri}}"
        status: "{{response.status}}"
        request_size: "{{request.size}}"
        response_size: "{{response.size}}"
        latency: "{{latencies.request}}"

  # Security headers
  - name: response-transformer
    config:
      add:
        headers:
          - "X-Content-Type-Options:nosniff"
          - "X-Frame-Options:DENY"
          - "X-XSS-Protection:1; mode=block"
          - "Strict-Transport-Security:max-age=31536000; includeSubDomains"

  # IP whitelist for admin endpoints
  - name: ip-restriction
    route:
      _path_: /grafana/*
    config:
      allow:
        - 127.0.0.1
        - ::1
        - 172.16.0.0/12  # Docker networks

  # Bot Detection and Rate Limiting
  - name: request-transformer
    config:
      add:
        headers:
          - "X-RateLimit-Limit:1000"
          - "X-RateLimit-Remaining:999"
          - "X-RateLimit-Reset:60"
    route:
      _path_: /api/*

  # Bot Protection - Block common bot patterns
  - name: ip-restriction
    config:
      allow:
        - 127.0.0.1
        - ::1
      deny:
        - 10.0.0.0/8  # Block common bot net ranges
        - 192.168.0.0/16

  # Circuit Breaker - Fail fast when backend is unhealthy
  - name: request-termination
    config:
      status_code: 503
      message: Service temporarily unavailable
      size: 10
      interval: 5
    route:
      _path_: /api/*

  # Response Rate Limiting - Limit responses per client
  - name: response-ratelimiting
    config:
      rate_limit_header: X-RateLimit-Remaining
      header_limit: X-RateLimit-Limit
      header_reset: X-RateLimit-Reset
      seconds: 60
      header_count: X-RateLimit-Count
    route:
      _path_: /api/*

  # Bot Protection - User-Agent filtering
  - name: response-transformer
    config:
      rename:
        headers:
          - "User-Agent:X-Bot-Detected"
    route:
      _path_: /api/*

# ==========================================
# UPSTREAMS (Load Balancing)
# ==========================================

upstreams:
  - name: backend-upstream
    targets:
      - target: backend:8080
        weight: 100
    healthchecks:
      active:
        http_path: "/actuator/health"
        healthy:
          interval: 5
      passive:
        healthy:
          successes: 3
    hash_on: header
    hash_fallback: none

# ==========================================
# CERTIFICATES (mTLS Configuration)
# ==========================================

certificates:
  # Kong Server Certificate
  - id: kong-server-cert
    cert: |
      -----BEGIN CERTIFICATE-----
$(cat /home/labadmin/projects/droid-spring/dev/certs/server/kong-cert.pem | sed 's/^/      /')
      -----END CERTIFICATE-----
    key: |
      -----BEGIN PRIVATE KEY-----
$(cat /home/labadmin/projects/droid-spring/dev/certs/server/kong-key.pem | sed 's/^/      /')
      -----END PRIVATE KEY-----
    snis:
      - name: kong.bss.local
        cert: kong-server-cert
      - name: localhost
        cert: kong-server-cert

# ==========================================
# MTLS CLIENT AUTHENTICATION
# ==========================================

# CA Certificate for Client Verification
ca_certificates:
  - id: bss-ca-cert
    cert: |
      -----BEGIN CERTIFICATE-----
$(cat /home/labadmin/projects/droid-spring/dev/certs/ca/ca-cert.pem | sed 's/^/      /')
      -----END CERTIFICATE-----

# ==========================================
# PARAMETERS
# ==========================================

_parameters:
  - name: api_version
    default: v1
    description: API version prefix
